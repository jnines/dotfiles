#!/bin/bash
##########################################################
#~ # Modules list
modules=(
nvidia
nvidia-drm
nvidia-uvm
nvidia-modeset
nvidia-peermem
)
# src directory
certDir="$HOME/.local/certs"
###########################################################
if [[ $1 == "-n" ]]; then
    kTkg="$2"
else
    kTkg="tkg"
fi
/usr/bin/gpg --decrypt-files "${certDir}/kernel_key.crt.gpg" "${certDir}/kernel_key.key.gpg" &&
sleep 10 &&
alg="sha512"
privKey="$certDir/kernel_key.key"
pubKey="$certDir/kernel_key.crt"
signFile="$certDir/sign-file"
export PATH=$PATH:"${signFile%/sign-file}"
echo Finding "${modules[@]}"
for i in "${modules[@]}"; do
    modulesW+=( "$(find /usr/lib/modules/*"$kTkg"*/updates/dkms/ -name "${i}.*")" )

done

for i in "${modulesW[@]}"; do
    sudo /usr/bin/zstd -dq --rm "${i}" &&
    sudo strip --strip-debug "${i%.zst}" &&
    sudo "$signFile" "$alg" "$privKey" "$pubKey" "${i%.zst}" &&
    echo Signing "${i}"
    sudo /usr/bin/zstd -q --rm "${i%.zst}"
done
/usr/bin/rm "${certDir}/kernel_key.crt" "${certDir}/kernel_key.key"
