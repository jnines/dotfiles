#!/bin/bash
##########################################################
#~ nzxt-kraken2
#~ nzxt-smartdevice
#~ it87
#~ # Modules list
modules=(
nvidia
nvidia-drm
nvidia-uvm
nvidia-modeset
nvidia-peermem
)
# src directory
certDir="$HOME/.local/certs"
#~ kSrc="$HOME/.local/bin/git/tkg/linux-tkg/src"
###########################################################
if [[ $1 == "-n" ]]; then
    kTkg="$2"
else
    kTkg="tkg"
fi
alg="sha512"
privKey="$certDir/signing_key.pem"
pubKey="$certDir/signing_key.x509"
signFile="$certDir/sign-file"
export PATH=$PATH:"${signFile%/sign-file}"
echo Finding "${modules[@]}"
for i in "${modules[@]}"; do
    modulesW+=( "$(find /usr/lib/modules/*"$kTkg"*/updates/dkms/ -name "${i}.*")" )

done

for i in "${modulesW[@]}"; do
    sudo /usr/bin/zstd -dq --rm "${i}" &&
    sudo strip --strip-debug "${i%.zst}" &&
    sudo "$signFile" "$alg" "$privKey" "$pubKey" "${i%.zst}" &&
    echo Signing "${i}"
    sudo /usr/bin/zstd -q --rm "${i%.zst}"
done
